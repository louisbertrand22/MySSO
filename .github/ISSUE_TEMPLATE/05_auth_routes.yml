name: "√âtape 5 - Routes API d‚Äôauthentification"
description: "Cr√©er les routes REST /auth pour l‚Äôinscription, la connexion, le rafra√Æchissement et la d√©connexion des utilisateurs."
title: "[√âtape 5] Routes API Auth (register, login, refresh, logout)"
labels:
  - backend
  - express
  - auth
  - √©tape-5
assignees:
  - copilothub[bot]
body:
  - type: markdown
    attributes:
      value: |
        ## üß© √âtape 5 - Routes d‚Äôauthentification API

        Nous allons maintenant exposer les routes REST n√©cessaires √† l‚Äôauthentification du SSO :
        - `POST /auth/register` ‚Äî cr√©ation d‚Äôun nouvel utilisateur (hash + DB)
        - `POST /auth/login` ‚Äî v√©rification des identifiants et g√©n√©ration des tokens
        - `POST /auth/refresh` ‚Äî renouvellement d‚Äôun access token √† partir du refresh token
        - `POST /auth/logout` ‚Äî suppression de la session ou du refresh token

        L‚Äôobjectif est d‚Äôavoir un **serveur Express/Fastify** minimal qui dialogue avec Prisma et utilise la logique d‚Äôauth d√©finie √† l‚Äô√©tape 4.

  - type: textarea
    id: dependencies
    attributes:
      label: D√©pendances serveur √† installer
      description: Librairies n√©cessaires pour cr√©er l‚ÄôAPI REST.
      value: |
        ```bash
        npm install express cors dotenv
        npm install --save-dev @types/express
        ```
    validations:
      required: true

  - type: textarea
    id: example_routes
    attributes:
      label: Exemple minimal de routes
      description: Exemple d‚Äôimpl√©mentation Express avec Prisma et les fonctions d‚Äôauthentification.
      value: |
        ```ts
        import express from "express"
        import cors from "cors"
        import dotenv from "dotenv"
        import { PrismaClient } from "@prisma/client"
        import { hashPassword, verifyPassword, generateAccessToken, generateRefreshToken } from "./auth"

        dotenv.config()
        const prisma = new PrismaClient()
        const app = express()
        app.use(cors())
        app.use(express.json())

        // üß© Register
        app.post("/auth/register", async (req, res) => {
          const { email, password } = req.body
          const existing = await prisma.user.findUnique({ where: { email } })
          if (existing) return res.status(400).json({ error: "User already exists" })

          const passwordHash = await hashPassword(password)
          const user = await prisma.user.create({ data: { email, passwordHash } })
          res.json({ user })
        })

        // üîê Login
        app.post("/auth/login", async (req, res) => {
          const { email, password } = req.body
          const user = await prisma.user.findUnique({ where: { email } })
          if (!user || !(await verifyPassword(password, user.passwordHash))) {
            return res.status(401).json({ error: "Invalid credentials" })
          }

          const accessToken = generateAccessToken(user.id)
          const refreshToken = generateRefreshToken(user.id)

          await prisma.refreshToken.create({ data: { userId: user.id, token: refreshToken, expiresAt: new Date(Date.now() + 7 * 24 * 3600 * 1000) } })

          res.json({ accessToken, refreshToken })
        })

        // üîÅ Refresh Token
        app.post("/auth/refresh", async (req, res) => {
          const { refreshToken } = req.body
          const stored = await prisma.refreshToken.findUnique({ where: { token: refreshToken } })
          if (!stored) return res.status(403).json({ error: "Invalid refresh token" })

          const newAccessToken = generateAccessToken(stored.userId)
          res.json({ accessToken: newAccessToken })
        })

        // üö™ Logout
        app.post("/auth/logout", async (req, res) => {
          const { refreshToken } = req.body
          await prisma.refreshToken.delete({ where: { token: refreshToken } }).catch(() => {})
          res.json({ message: "Logged out" })
        })

        const PORT = process.env.PORT || 3000
        app.listen(PORT, () => console.log(`‚úÖ Auth API running on port ${PORT}`))
        ```
    validations:
      required: true

  - type: input
    id: test_routes
    attributes:
      label: Tests √† effectuer
      description: Liste les routes √† tester avec Postman / Insomnia.
      placeholder: |
        POST /auth/register
        POST /auth/login
        POST /auth/refresh
        POST /auth/logout

  - type: markdown
    attributes:
      value: |
        ---
        ‚úÖ **Checklist :**
        - [ ] Serveur Express lanc√© sans erreur
        - [ ] Inscription et connexion fonctionnelles
        - [ ] JWT re√ßu apr√®s `POST /auth/login`
        - [ ] Refresh token valide et stock√© dans la DB
        - [ ] D√©connexion supprime le refresh token
